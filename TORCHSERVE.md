# Torchserve Guideline

## Docker Installation
- Train/Infer image (for .mar file)
```bash
$ docker build -t mmdetection3d docker/
```
- Torch serve Image
```bash
$ docker build -t mmdet3d-serve-j911:latest -f docker/serve/Dockerfile .
```

## create .mar file
```bash
$ docker run --gpus all --shm-size=8g -it -v {REPO_DIR}:/ws mmdetection3d
$ cd /ws/torchserve-example
$ wget https://download.openmmlab.com/mmdetection3d/v1.1.0_models/pv_rcnn/pv_rcnn_8xb2-80e_kitti-3d-3class/pv_rcnn_8xb2-80e_kitti-3d-3class_20221117_234428-b384d22f.pth
$ torch-model-archiver --model-name "pv-rcnn" --model-file config.py --version 1.0 --serialized-file pv_rcnn_8xb2-80e_kitti-3d-3class_20221117_234428-b384d22f.pth --handler ../tools/deployment/mmdet3d_handler.py
```

## Start torchserve
``` bash
$ docker run --gpus '"device=0"' -it --rm --shm-size 50G -p8080:8080 -p8081:8081 -p8082:8082 --mount type=bind,source={MODEL_STORE},target=/home/model-server/model-store mmdet3d-serve-j911
```

## Testing
```bash
$ curl --location '192.168.4.55:8080/predictions/pv-rcnn' \
--form 'data=@"{REPO_DIR}/demo/data/kitti/000008.bin"' \
--form 'format="bin"'


---response---
[
  {
    "obj_id": "",
    "obj_type": "2 (0.999781)",
    "psr": {
      "position": {
        "x": 8.140633583068848,
        "y": 1.2509441375732422,
        "z": -0.8274788856506348
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 2.8443007469177246
      },
      "scale": {
        "x": 3.655350923538208,
        "y": 1.5547128915786743,
        "z": 1.588292121887207
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "2 (0.999744)",
    "psr": {
      "position": {
        "x": 14.751160621643066,
        "y": -1.029496192932129,
        "z": -0.7554811835289001
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 5.980472087860107
      },
      "scale": {
        "x": 3.720879316329956,
        "y": 1.5559364557266235,
        "z": 1.501611351966858
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "2 (0.998573)",
    "psr": {
      "position": {
        "x": 6.46837854385376,
        "y": -3.855586051940918,
        "z": -1.0208356380462646
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 5.98028564453125
      },
      "scale": {
        "x": 3.0530569553375244,
        "y": 1.4884668588638306,
        "z": 1.4647090435028076
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "2 (0.994770)",
    "psr": {
      "position": {
        "x": 33.625572204589844,
        "y": -7.092714786529541,
        "z": -0.44371193647384644
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 2.866128921508789
      },
      "scale": {
        "x": 4.220332622528076,
        "y": 1.807590126991272,
        "z": 1.7676883935928345
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "2 (0.957477)",
    "psr": {
      "position": {
        "x": 41.035240173339844,
        "y": -9.788379669189453,
        "z": -0.5678097009658813
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 5.900407791137695
      },
      "scale": {
        "x": 3.807467222213745,
        "y": 1.643918514251709,
        "z": 1.6128525733947754
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "2 (0.953207)",
    "psr": {
      "position": {
        "x": 3.6953046321868896,
        "y": 2.7638309001922607,
        "z": -0.8445456624031067
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 6.001869201660156
      },
      "scale": {
        "x": 3.6863880157470703,
        "y": 1.5540082454681396,
        "z": 1.5235308408737183
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "2 (0.927022)",
    "psr": {
      "position": {
        "x": 20.375844955444336,
        "y": -8.493083000183105,
        "z": -0.9367954134941101
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 5.944627285003662
      },
      "scale": {
        "x": 2.7711682319641113,
        "y": 1.5553292036056519,
        "z": 1.5693193674087524
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "2 (0.923453)",
    "psr": {
      "position": {
        "x": 28.729442596435547,
        "y": -1.5814929008483887,
        "z": -0.33173251152038574
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 4.41451358795166
      },
      "scale": {
        "x": 3.790403366088867,
        "y": 1.527924656867981,
        "z": 1.5104641914367676
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "2 (0.911804)",
    "psr": {
      "position": {
        "x": 25.087909698486328,
        "y": -10.082205772399902,
        "z": -0.9653075933456421
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 5.9744720458984375
      },
      "scale": {
        "x": 3.872107982635498,
        "y": 1.632473349571228,
        "z": 1.4937443733215332
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "2 (0.853632)",
    "psr": {
      "position": {
        "x": 55.45502471923828,
        "y": -20.262531280517578,
        "z": -0.5320668816566467
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 2.789188861846924
      },
      "scale": {
        "x": 4.192314624786377,
        "y": 1.726433277130127,
        "z": 1.628273367881775
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "1 (0.784425)",
    "psr": {
      "position": {
        "x": 33.6094970703125,
        "y": -15.37845230102539,
        "z": -0.5858117341995239
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 2.87926983833313
      },
      "scale": {
        "x": 1.7572641372680664,
        "y": 0.533711314201355,
        "z": 1.7368614673614502
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "0 (0.506784)",
    "psr": {
      "position": {
        "x": 37.276954650878906,
        "y": -6.068307399749756,
        "z": -0.3206292390823364
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 6.158722400665283
      },
      "scale": {
        "x": 0.5752694606781006,
        "y": 0.6680884957313538,
        "z": 1.8951842784881592
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "0 (0.438885)",
    "psr": {
      "position": {
        "x": 29.99823570251465,
        "y": -14.098929405212402,
        "z": -0.6938499212265015
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 4.7670769691467285
      },
      "scale": {
        "x": 0.7509111166000366,
        "y": 0.60819411277771,
        "z": 1.8454086780548096
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "2 (0.288955)",
    "psr": {
      "position": {
        "x": 52.640037536621094,
        "y": -22.2760066986084,
        "z": -0.5016016364097595
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 5.9207539558410645
      },
      "scale": {
        "x": 3.7423577308654785,
        "y": 1.5608364343643188,
        "z": 1.5367470979690552
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "0 (0.199129)",
    "psr": {
      "position": {
        "x": 40.60084915161133,
        "y": -7.2121782302856445,
        "z": -0.4245665669441223
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 6.34514045715332
      },
      "scale": {
        "x": 0.5804817080497742,
        "y": 0.6513271927833557,
        "z": 1.875883936882019
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "0 (0.184059)",
    "psr": {
      "position": {
        "x": 34.02936935424805,
        "y": -4.954355239868164,
        "z": -0.42702341079711914
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 5.954281806945801
      },
      "scale": {
        "x": 0.5407652854919434,
        "y": 0.7028929591178894,
        "z": 1.81333589553833
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "1 (0.161524)",
    "psr": {
      "position": {
        "x": 30.307964324951172,
        "y": -3.715122699737549,
        "z": -0.32333898544311523
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 6.07246732711792
      },
      "scale": {
        "x": 1.7681888341903687,
        "y": 0.575222373008728,
        "z": 1.7038764953613281
      }
    }
  },
  {
    "obj_id": "",
    "obj_type": "0 (0.154681)",
    "psr": {
      "position": {
        "x": 53.62678146362305,
        "y": -16.222492218017578,
        "z": -0.22643232345581055
      },
      "rotation": {
        "x": 0,
        "y": 0,
        "z": 2.713113784790039
      },
      "scale": {
        "x": 0.821942925453186,
        "y": 0.5675030946731567,
        "z": 1.9439342021942139
      }
    }
  }
]
```
